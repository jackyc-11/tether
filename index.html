<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DesignFTW Chatroom</title>
    <script type="importmap">
    {
      "imports": {
        "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
        "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
        "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
        "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs",
        "@graffiti-garden/wrapper-files": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-files@0.0.1/dist/browser/index.js"
      }
    }
    </script>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-mart@latest/css/emoji-mart.css" />
  </head>
  <body>
    <div id="app">

      <div v-if="!$graffitiSession.value" class="login-screen">
        <!-- add tether title and logo, make screen look nicer -->
        <button class="btn-login" @click="$graffiti.login()">Log In</button>
      </div>

      <div v-else class="app-container">
        <!-- NAV -->
        <section class="nav-panel">
          <div class="nav-item" :class="{ active: currentTab==='messages' }" @click="currentTab='messages'">
            <img src="images/dark-msg-section.png" alt="Messages" />
          </div>
          <div class="nav-item" :class="{ active: currentTab==='friends' }" @click="currentTab='friends'">
            <img src="images/dark-friend-section.png" alt="Friends" />
          </div>
          <div class="nav-item" :class="{ active: currentTab==='settings' }" @click="currentTab='settings'">
            <img src="images/dark-setting-section.png" alt="Settings" />
          </div>
        </section>

        <!-- MESSAGES TAB -->
        <section v-if="currentTab==='messages'" class="panel user-list">
          <list-section 
            title="Chats"
            :items="users"
            :show-remove="false"
            @select="selectUser"
          />
        </section>
        <section v-if="currentTab==='messages'" class="panel chat-window">
          <template v-if="selectedChannel">
            <div class="feature-bar">
              <button
                :class="{ active: selectedFeature==='mood' }"
                @click="selectedFeature = selectedFeature==='mood' ? null : 'mood'"
              >
                <strong>Mood Map ü§î</strong>
              </button>
              <button
                :class="{ active: selectedFeature==='postit' }"
                @click="selectedFeature='postit'"
              >
                <strong>Post-It Wall üìù</strong>
              </button>
              <button
                :class="{ active: selectedFeature==='weather' }"
                @click="selectedFeature='weather'"
              >
                <strong>Weathering With You ‚òÅÔ∏è</strong>
              </button>
            </div>

            <div v-if="selectedFeature==='mood'" class="mood-map-panel">
          
              <div class="mood-display">
                <div class="user-emoji">
                  <strong>You:</strong>
                  <div class="emoji-box static" @click="toggleEmojiPicker()">{{ myEmoji || "" }}</div>
                  <button class="close-btn" @click="selectedFeature = null">‚úñ</button>
                </div>
                <div class="user-emoji">
                  <strong>{{ selectedUser?.name || "Them" }}:</strong>
                  <div class="emoji-box static">{{ otherEmoji || "" }}</div>
                </div>
              </div>
          
              <div v-if="showEmojiPicker" class="emoji-picker-container" ref="emojiPickerContainer">
                <!-- Emoji-mart will be mounted here -->
              </div>
            </div>

            <section class="messages">
              <graffiti-discover autopoll
                v-slot="{ objects: msgs = [], isInitialPolling }"
                :channels="[selectedChannel]"
                :schema="messageSchema"
              >
                <div v-if="isInitialPolling" class="loading">Loading‚Ä¶</div>
                <div
                  v-for="m in (Array.isArray(objects) ? objects : []).sort((a,b)=>a.value.published - b.value.published)"
                  :key="m.url"
                  class="message"
                  :class="{ mine: m.actor === session?.actor, editing: editingObject?.url === m.url }"
                >
                  <div class="message-content">
                    <strong>{{ m.actor === session?.actor ? 'You' : m.actor }}</strong>
                    {{ m.value.content }}
                  </div>
                  <div class="msg-controls" v-if="m.actor === session?.actor">
                    <button @click="startEdit(m)" class="edit-btn">Edit</button>
                    <button @click="deleteMessage(m)" class="delete-btn">Delete</button>
                  </div>
                </div>
              </graffiti-discover>
            </section>
            <form class="composer" @submit.prevent="editingMessage ? updateMessage() : sendMessage()">
              <input v-model="myMessage" placeholder="Type a message‚Ä¶" ref="messageInput" required />
              <button type="submit">{{ editingMessage ? 'Update' : 'Send' }}</button>
              <button v-if="editingMessage" type="button" @click="cancelEdit" class="cancel-btn">Cancel</button>
            </form>
          </template>
          <template v-else>
            <div class="no-chat">Select a user to chat.</div>
          </template>
        </section>

        <!-- FRIENDS TAB -->
        <section v-if="currentTab==='friends'" class="panel user-list">
          <h2>Friends</h2>
          <ul class="friend-nav">
            <li v-for="opt in friendOptions" :key="opt.key"
                :class="{ selected: friendTab===opt.key }"
                @click="friendTab=opt.key">
              <img class="friend-nav-icon" :src="opt.icon" />
              {{ opt.label }}
            </li>
          </ul>
        </section>
        <section v-if="currentTab==='friends'" class="panel chat-window friends-panel">
          <template v-if="friendTab==='list'">
            <list-section 
              title="Your Friends"
              :items="acceptedFriends"
              :show-remove="true"
              @select="selectUser"
              @remove="removeFriend"
            />
          </template>

          <template v-else-if="friendTab==='add'">
            <h2>Add Friends</h2>
              <input
                type="text"
                class="search-bar"
                placeholder="Search Tether"
                v-model="searchTerm"
              />
            <section class="add-friends-container">
              <ul class="users-list">
                <li
                  v-for="user in filteredUsers"
                  :key="user.id"
                  class="user-item"
                >
                  <div class="user-avatar">
                    <img :src="user.iconUrl || 'images/profile.png'" alt="img" />
                  </div>
                  <div class="user-info">
                    {{ user.name }}
                  </div>
                  <div class="user-actions">
                    <button
                      v-if="outgoingRequests.includes(user.id)"
                      @click="cancelRequest(user.id)"
                      class="cancel-request-btn"
                    >
                      Cancel Request
                    </button>
                  
                    <button
                      v-else
                      @click="addFriend(user.id)"
                      class="add-friend-btn"
                    >
                      Add Friend
                    </button>
                  </div>
                </li>
              </ul>
          
              <div v-if="filteredUsers.length === 0" class="no-results">
                No users to add.
              </div>
            </section>
          </template>

          <template v-else-if="friendTab==='requests'">
            <list-section 
              title="Incoming Requests"
              :items="friendRequests"
              :show-remove="false"
              @select="addFriend"
            />
            
            <list-section 
              title="Sent Requests"
              :items="sentRequests"
              :show-remove="true"
              @remove="cancelRequest"
            />
          </template>

        </section>

        <!-- SETTINGS / PROFILE TAB -->
        <section v-if="currentTab==='settings'" class="panel chat-window settings-panel">
          <h2>{{ profileObject?.value?.name || session.actor }}'s Profile</h2>
          <form class="profile-form" @submit.prevent="saveProfile">
            <label>
              Picture
              <input type="file" accept="image/*" @change="onProfilePicChange" />
            </label>
            <div v-if="profilePicPreview" class="profile-preview">
              <img :src="profilePicPreview" alt="Preview" />
              <button type="button" class="btn-remove-pic" @click="removeProfilePic()">
                Remove
              </button>
            </div>
            <label>
              Name
              <input v-model="profileName" placeholder="Name" />
            </label>
            <label>
              Pronouns
              <input v-model="profilePronouns" placeholder="Pronouns" />
            </label>
            <label>
              Bio
              <textarea v-model="profileBio" placeholder="Short bio‚Ä¶"></textarea>
            </label>
            <button type="submit" :class="{ 'saved-btn': saved }">
              {{ saved ? 'Saved!' : 'Save Profile' }}
            </button>
          </form>
          <button v-if="$graffitiSession.value" class="logout-btn" @click=$graffiti.logout($graffitiSession.value)>Log Out</button>
        </section>
      </div>
    </div>

    <script src="index.js" type="module"></script>
  </body>
</html>